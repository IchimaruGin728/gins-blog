---
import Layout from "../../../layouts/Layout.astro";

// Protect Route handled by Middleware (Zero Trust)
const env = Astro.locals.runtime.env;

// Helper for safe DB queries
async function safeFetch<T>(promise: Promise<T>, fallback: T): Promise<T> {
  try {
    return await promise;
  } catch (e) {
    console.error("DB Error:", e);
    return fallback;
  }
}

// Analytics Data
const postCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM posts").first<number>("count"),
  0,
);

const userCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM users").first<number>("count"),
  0,
);

const activeSessionCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM sessions WHERE expires_at > ?")
    .bind(Date.now())
    .first<number>("count"),
  0,
);

// Prevent Caching
Astro.response.headers.set(
  "Cache-Control",
  "no-cache, no-store, must-revalidate",
);
Astro.response.headers.set("Pragma", "no-cache");
Astro.response.headers.set("Expires", "0");
const recentPosts = await safeFetch(
  env.DB.prepare(
    "SELECT * FROM posts ORDER BY publishedAt DESC LIMIT 10",
  ).all(),
  // @ts-ignore
  { results: [], success: false, meta: {} },
);
---

<Layout title="Dashboard - Ichimaru Gin">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header
      class="mb-12 flex flex-col md:flex-row justify-between items-center gap-6"
    >
      <div class="flex items-center gap-8 w-full md:w-auto">
        <div>
          <h1
            class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-brand-primary"
          >
            Analytics Center
          </h1>
          <p class="text-gray-400 mt-2">Real-time data stream.</p>
        </div>

        <!-- Admin Search Box -->
        <div class="hidden md:block relative group flex-1 min-w-[300px] z-20">
          <input
            type="text"
            id="admin-search-input"
            placeholder="Search Global Signals..."
            class="w-full bg-black/40 border border-white/10 rounded-full px-5 py-2.5 focus:outline-none focus:border-brand-accent focus:bg-black/60 transition-all text-white text-sm"
          />
          <div
            id="admin-search-results"
            class="absolute top-full left-0 mt-2 w-full glass-panel rounded-2xl p-2 hidden z-50"
          >
            <!-- Results injected here -->
          </div>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <a
          href="/IchimaruGin728/admin/music"
          class="px-4 py-2 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-colors text-sm flex items-center gap-2"
        >
          <span class="i-heroicons-musical-note"></span>
          Music Manager
        </a>
        <a
          href="/"
          class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 transition-colors text-sm"
        >
          Back to Site
        </a>
      </div>
    </header>

    <!-- Analytics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
      <div class="glass-panel p-6 rounded-2xl">
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Total Signals
        </div>
        <div class="text-4xl font-bold font-display">{postCount}</div>
      </div>
      <div class="glass-panel p-6 rounded-2xl">
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Total Users
        </div>
        <div class="text-4xl font-bold font-display">{userCount}</div>
      </div>
      <div class="glass-panel p-6 rounded-2xl">
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Active Sessions
        </div>
        <div class="text-4xl font-bold font-display">{activeSessionCount}</div>
      </div>
      <div
        class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-brand-primary/20 to-transparent border-brand-primary/30"
      >
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          System Status
        </div>
        <div class="flex items-center gap-2 text-green-400 font-bold">
          <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
          OPERATIONAL
        </div>
      </div>
    </div>
  </div>

  <!-- Signal Log List -->
  <div class="glass-panel p-8 rounded-3xl mb-12">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Signal Log</h2>
      <div id="signal-log-count" class="text-xs font-mono text-gray-400">
        Showing Recent 10
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse" id="signal-log-table">
        <thead>
          <tr
            class="text-gray-400 border-b border-white/10 text-xs uppercase tracking-wider font-mono"
          >
            <th class="py-4 font-normal">Status</th>
            <th class="py-4 font-normal">Title</th>
            <th class="py-4 font-normal">Published</th>
            <th class="py-4 font-normal text-right">Action</th>
          </tr>
        </thead>
        <tbody class="text-sm" id="signal-log-body">
          {
            (recentPosts.results || []).map((post: any) => {
              const isPublished = Date.now() >= (post.publishedAt || 0);
              return (
                <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                  <td class="py-4">
                    <span
                      class={`inline-block w-2 h-2 rounded-full ${isPublished ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]" : "bg-yellow-400"}`}
                    />
                  </td>
                  <td class="py-4 font-medium text-white">{post.title}</td>
                  <td class="py-4 text-gray-400 font-mono text-xs">
                    {new Date(
                      post.publishedAt || post.createdAt,
                    ).toLocaleDateString()}
                  </td>
                  <td class="py-4 text-right flex items-center justify-end gap-2">
                    <button
                      class="edit-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-brand-primary/20 text-gray-300 hover:text-brand-accent border border-white/10 hover:border-brand-primary/50 transition-all text-xs"
                      data-slug={post.slug}
                      title="Edit Post"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                        />
                      </svg>
                    </button>
                    <button
                      class="toggle-status-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-gray-300 hover:text-yellow-400 border border-white/10 hover:border-yellow-500/50 transition-all text-xs"
                      data-slug={post.slug}
                      data-status={isPublished ? "published" : "draft"}
                      title={
                        isPublished ? "Unpublish (Hide)" : "Publish (Show)"
                      }
                    >
                      {isPublished ? (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="w-4 h-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"
                          />
                        </svg>
                      ) : (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="w-4 h-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                          />
                        </svg>
                      )}
                    </button>
                    <button
                      class="delete-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/10 hover:border-red-500/50 transition-all text-xs"
                      data-slug={post.slug}
                      title="Delete Post"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                        />
                      </svg>
                    </button>
                  </td>
                </tr>
              );
            })
          }
        </tbody>
      </table>
    </div>

    <div class="mt-6 flex justify-center">
      <button
        id="load-all-signals-btn"
        class="px-6 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-mono tracking-widest uppercase transition-colors text-gray-400 hover:text-white"
      >
        Load Full Archive
      </button>
    </div>
  </div>

  <!-- Editor Section -->
  <div class="glass-panel p-8 rounded-3xl">
    <h2 class="text-2xl font-bold mb-6">Transmission Uplink</h2>

    <form id="create-post-form" class="space-y-6">
      <input type="hidden" name="id" id="post-id" />
      <div class="grid grid-cols-3 gap-6">
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >SIGNAL_TITLE</label
          >
          <input
            type="text"
            name="title"
            id="title-input"
            required
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >SIGNAL_SLUG</label
          >
          <input
            type="text"
            name="slug"
            id="slug-input"
            required
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >PUBLISHED_AT</label
          >
          <input
            type="datetime-local"
            name="publishedAt"
            id="published-at-input"
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white calendar-picker-indicator:invert"
          />
          <p class="text-xs text-gray-500 mt-1">
            Set a past or future date to override publication time
          </p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >UPDATED_AT</label
          >
          <div class="flex items-center gap-4">
            <input
              type="datetime-local"
              name="updatedAt"
              id="updated-at-input"
              class="flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white disabled:opacity-50"
              disabled
            />
            <label class="flex items-center gap-2 cursor-pointer group">
              <input
                type="checkbox"
                id="auto-update-toggle"
                checked
                class="w-5 h-5 rounded border-white/20 bg-white/5 text-brand-accent focus:ring-brand-accent focus:ring-offset-0 transition-all"
              />
              <span
                class="text-xs text-gray-400 group-hover:text-gray-200 transition-colors"
                >Auto-Update</span
              >
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Manually override modification time or keep it automatic
          </p>
        </div>
      </div>
    </form>

    <!-- Markdown Editor with Toolbar -->
    <div class="border border-white/10 rounded-xl overflow-hidden bg-black/20">
      <div
        class="flex items-center gap-2 p-2 border-b border-white/10 bg-white/5"
      >
        <button
          type="button"
          class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
          title="Bold">B</button
        >
        <button
          type="button"
          class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
          title="Italic">I</button
        >
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <button
          type="button"
          id="upload-btn"
          class="flex items-center gap-2 px-3 py-1.5 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors text-sm"
        >
          <span class="i-heroicons-photo"></span>
          Upload Media
        </button>
        <input
          type="file"
          id="file-input"
          class="hidden"
          accept="image/*, .gif, .ppt, .pptx, .doc, .docx, .xls, .xlsx, .csv"
        />
      </div>
      <textarea
        id="content-area"
        name="content"
        form="create-post-form"
        rows="15"
        required
        class="w-full bg-transparent p-4 focus:outline-none font-mono text-sm leading-relaxed resize-y"
        placeholder="Initiate transmission..."></textarea>
    </div>

    <div class="flex items-center gap-4">
      <button
        type="submit"
        form="create-post-form"
        class="relative z-10 flex-1 py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-accent hover:opacity-90 hover:scale-[1.01] active:scale-[0.98] text-white font-bold tracking-wider transition-all cursor-pointer shadow-lg hover:shadow-brand-accent/25"
      >
        BROADCAST SIGNAL
      </button>
      <button
        type="button"
        id="delete-current-btn"
        class="hidden px-6 py-4 rounded-xl bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 font-bold tracking-wider transition-colors"
      >
        <span class="i-heroicons-trash w-5 h-5"></span>
      </button>
    </div>

    <div id="status" class="hidden p-4 rounded-xl text-center text-sm"></div>
  </div>

  <!-- Success Modal Overlay -->
  <div
    id="success-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 pointer-events-none"
  >
    <div class="relative w-full max-w-lg flex flex-col items-center">
      <!-- Glitch/Success Effect (Like 404) -->
      <div
        class="relative mb-8 transform scale-90 md:scale-100 transition-transform duration-300 delay-100 pointer-events-none"
      >
        <h1
          class="text-9xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-white/10 opacity-20 select-none"
        >
          200
        </h1>
        <div class="absolute inset-0 flex items-center justify-center">
          <h2
            class="text-4xl md:text-5xl font-bold font-display text-green-400 drop-shadow-[0_0_15px_rgba(74,222,128,0.5)] animate-pulse flex items-center justify-center gap-3 whitespace-nowrap"
          >
            <span class="i-heroicons-check-circle text-5xl"></span>
            <span>Signal Live!</span>
          </h2>
        </div>
      </div>

      <div
        class="glass-panel p-8 md:p-12 rounded-3xl w-full text-center transform scale-95 transition-transform duration-300 border border-white/10 shadow-2xl"
      >
        <p class="text-xl md:text-2xl font-medium text-white mb-4">
          Transmission Successful
        </p>
        <p class="text-gray-400 font-mono text-sm leading-relaxed mb-8">
          The signal has been injected into the network stream.<br />
          All systems operational.
        </p>

        <div class="flex flex-col gap-4 items-center w-full">
          <a
            id="verify-signal-btn"
            href="#"
            target="_blank"
            class="group relative w-full py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-accent hover:opacity-90 text-white font-bold transition-all flex items-center justify-center gap-2 overflow-hidden shadow-[0_0_20px_rgba(139,92,246,0.3)] hover:shadow-[0_0_30px_rgba(139,92,246,0.5)]"
          >
            <div
              class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"
            >
            </div>
            <span class="relative z-10">Verify Signal</span>
            <span
              class="i-heroicons-arrow-top-right-on-square w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform"
            ></span>
          </a>

          <button
            id="return-uplink-btn"
            class="group relative w-full py-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 text-gray-400 hover:text-white transition-all flex items-center justify-center gap-2"
          >
            <span
              class="i-heroicons-arrow-path w-5 h-5 group-hover:-rotate-180 transition-transform duration-500"
            ></span>
            <span>Return to Uplink</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { hc } from "hono/client";
  import type { AppType } from "../../api/[...path]";

  const client = hc<AppType>(window.location.origin);
  const form = document.getElementById("create-post-form") as HTMLFormElement;

  // Bind Edit Buttons (Recent List)
  const bindActionButtons = () => {
    document.querySelectorAll(".edit-post-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const slug = (e.currentTarget as HTMLElement).dataset.slug;
        if (slug) {
          loadPostForEdit(slug);
        }
      });
    });

    document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const target = e.currentTarget as HTMLElement;
        const slug = target.dataset.slug;
        const currentStatus = target.dataset.status;
        const action = currentStatus === "published" ? "unpublish" : "publish";

        if (!confirm(`Are you sure you want to ${action} this signal?`)) return;

        try {
          const res = await fetch(`/api/posts/${slug}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action }),
          });
          if (res.ok) {
            window.location.reload(); // Refresh to show status change
          } else {
            alert("Failed to update status");
          }
        } catch (err) {
          console.error(err);
        }
      });
    });

    document.querySelectorAll(".delete-post-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const slug = (e.currentTarget as HTMLElement).dataset.slug;
        if (
          !confirm("WARNING: This will permanently delete the signal. Proceed?")
        )
          return;

        try {
          const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
          if (res.ok) {
            window.location.reload();
          } else {
            alert("Failed to delete signal");
          }
        } catch (err) {
          console.error(err);
        }
      });
    });
  };

  bindActionButtons();

  // Ensure fresh state on navigation (fix BFCache)
  window.addEventListener("pageshow", () => {
    form.reset();
    document.getElementById("post-id")?.setAttribute("value", "");
    // Reset button text
    const btn = document.querySelector('button[type="submit"]');
    if (btn) btn.innerHTML = "BROADCAST SIGNAL";
  });
  const status = document.getElementById("status");
  const fileInput = document.getElementById("file-input") as HTMLInputElement;
  const uploadBtn = document.getElementById("upload-btn");
  const autoUpdateToggle = document.getElementById(
    "auto-update-toggle",
  ) as HTMLInputElement;
  const updatedAtInput = document.getElementById(
    "updated-at-input",
  ) as HTMLInputElement;

  autoUpdateToggle?.addEventListener("change", () => {
    updatedAtInput.disabled = autoUpdateToggle.checked;
    if (autoUpdateToggle.checked) {
      updatedAtInput.value = "";
    } else {
      // Set current time as default when unlocking
      const now = new Date();
      updatedAtInput.value = new Date(
        now.getTime() - now.getTimezoneOffset() * 60000,
      )
        .toISOString()
        .slice(0, 16);
    }
  });
  // @ts-ignore
  const textarea = document.getElementById(
    "content-area",
  ) as HTMLTextAreaElement;

  // File Upload Handler
  uploadBtn?.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    uploadBtn!.innerText = "Uploading...";

    try {
      const res = await fetch(
        `/api/upload?filename=${encodeURIComponent(file.name)}`,
        {
          method: "PUT",
          body: file,
        },
      );

      if (res.ok) {
        const data = (await res.json()) as any;
        // Insert Markdown Image syntax
        const cursorPosition = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPosition);
        const textAfter = textarea.value.substring(
          cursorPosition,
          textarea.value.length,
        );
        const imageMarkdown = `\n![${file.name}](${data.url})\n`;

        textarea.value = textBefore + imageMarkdown + textAfter;
        uploadBtn!.innerHTML =
          '<span class="i-heroicons-check"></span> Uploaded';
        setTimeout(() => {
          uploadBtn!.innerHTML =
            '<span class="i-heroicons-photo"></span> Upload Media';
        }, 2000);
      }
    } catch (err) {
      console.error(err);
      uploadBtn!.innerText = "Failed";
    }
  });

  // Post Submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    status!.className = "hidden p-4 rounded-xl text-center text-sm";

    // Validation Check
    if (!formData.get("title") || !formData.get("slug")) {
      alert("Missing Critical Data: Title or Slug required.");
      return;
    }

    // Verify FormData capture
    console.log("ðŸ“¦ Form Payload:", Object.fromEntries(formData));

    try {
      const res = await client.api.posts.$post({
        form: {
          id: formData.get("id") as string,
          title: formData.get("title") as string,
          slug: formData.get("slug") as string,
          content: formData.get("content") as string,
          publishedAt: formData.get("publishedAt") as string,
          updatedAt: formData.get("updatedAt") as string,
        },
      });

      if (res.ok) {
        // ... (success logic remains the same)
        const modal = document.getElementById("success-modal");
        const verifyBtn = document.getElementById(
          "verify-signal-btn",
        ) as HTMLAnchorElement;
        const returnBtn = document.getElementById("return-uplink-btn");
        const slug = formData.get("slug") as string;

        verifyBtn.href = `/blog/${slug}`;

        modal?.classList.remove("hidden", "pointer-events-none");
        void modal?.offsetWidth;
        modal?.classList.remove("opacity-0");
        modal?.querySelector(".glass-panel")?.classList.remove("scale-95");
        modal?.querySelector(".glass-panel")?.classList.add("scale-100");

        form.reset();
        document.getElementById("delete-current-btn")?.classList.add("hidden");
        document.querySelector('button[type="submit"]')!.innerHTML =
          "BROADCAST SIGNAL";

        returnBtn?.addEventListener("click", () => {
          modal?.classList.add("opacity-0", "pointer-events-none");
          modal?.querySelector(".glass-panel")?.classList.add("scale-95");
          setTimeout(() => modal?.classList.add("hidden"), 300);
          window.location.reload();
        });
      } else {
        const errorData = (await res
          .json()
          .catch(() => ({ error: res.statusText }))) as any;
        console.error("Transmission Error:", errorData);
        status!.innerText = `Transmission Failed: ${errorData.error || "Unknown Error"} (${res.status})`;
        status!.classList.remove("hidden");
        status!.classList.add("bg-red-500/20", "text-red-200");
      }
    } catch (err) {
      console.error(err);
      status!.innerText = "Network Error.";
      status!.classList.remove("hidden");
      status!.classList.add("bg-red-500/20", "text-red-200");
    }
  });

  // Handle Delete from Editor
  const deleteCurrentBtn = document.getElementById("delete-current-btn");
  deleteCurrentBtn?.addEventListener("click", async () => {
    const slug = (document.getElementById("slug-input") as HTMLInputElement)
      .value;
    if (!slug) return;

    if (
      !confirm(
        "CRITICAL WARNING: This will permanently purge this signal from the database. This action is irreversible. Proceed?",
      )
    )
      return;

    try {
      const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
      if (res.ok) {
        window.location.reload();
      } else {
        alert("Failed to delete signal");
      }
    } catch (err) {
      console.error(err);
      alert("Network Error");
    }
  });

  // --- Global Search Logic ---
  const searchInput = document.getElementById(
    "admin-search-input",
  ) as HTMLInputElement;
  const resultsContainer = document.getElementById("admin-search-results");
  let debounceTimer: ReturnType<typeof setTimeout>;

  async function loadPostForEdit(slug: string) {
    try {
      const res = await fetch(`/api/posts/${slug}`);
      if (res.ok) {
        const post = (await res.json()) as any;
        // Populate Form
        (document.getElementById("post-id") as HTMLInputElement).value =
          post.id;
        (document.getElementById("title-input") as HTMLInputElement).value =
          post.title;
        (document.getElementById("slug-input") as HTMLInputElement).value =
          post.slug;
        (document.getElementById("content-area") as HTMLTextAreaElement).value =
          post.content;

        if (post.publishedAt) {
          const date = new Date(post.publishedAt);
          const iso = new Date(
            date.getTime() - date.getTimezoneOffset() * 60000,
          )
            .toISOString()
            .slice(0, 16);
          (
            document.getElementById("published-at-input") as HTMLInputElement
          ).value = iso;
        }

        if (post.updatedAt) {
          const date = new Date(post.updatedAt);
          const iso = new Date(
            date.getTime() - date.getTimezoneOffset() * 60000,
          )
            .toISOString()
            .slice(0, 16);
          updatedAtInput.value = iso;
          autoUpdateToggle.checked = false;
          updatedAtInput.disabled = false;
        } else {
          updatedAtInput.value = "";
          autoUpdateToggle.checked = true;
          updatedAtInput.disabled = true;
        }

        // Scroll to editor
        document
          .getElementById("create-post-form")
          ?.scrollIntoView({ behavior: "smooth" });

        // Update Button Text & Show Delete
        const btn = document.querySelector('button[type="submit"]');
        if (btn) btn.innerHTML = "UPDATE SIGNAL";

        document
          .getElementById("delete-current-btn")
          ?.classList.remove("hidden");
      }
    } catch (e) {
      console.error("Failed to load post", e);
    }
  }

  if (searchInput && resultsContainer) {
    searchInput.addEventListener("input", (e) => {
      const query = (e.target as HTMLInputElement).value;
      clearTimeout(debounceTimer);

      if (query.length < 2) {
        resultsContainer.classList.add("hidden");
        return;
      }

      debounceTimer = setTimeout(async () => {
        try {
          const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
          const matches = (await res.json()) as any[];

          if (matches.length > 0) {
            resultsContainer.innerHTML = matches
              .map(
                (match: any) => `
                          <div data-slug="${match.metadata.slug}" class="search-result-item block p-3 hover:bg-white/10 rounded-xl transition-colors cursor-pointer">
                              <div class="font-bold text-white text-sm">${match.metadata.title}</div>
                              <div class="text-xs text-brand-accent mt-1">${(match.score * 100).toFixed(1)}% Match â€¢ Click to Edit</div>
                          </div>
                      `,
              )
              .join("");
            resultsContainer.classList.remove("hidden");

            // Add click listeners to results
            document.querySelectorAll(".search-result-item").forEach((item) => {
              item.addEventListener("click", async (ev) => {
                const slug = (ev.currentTarget as HTMLElement).dataset.slug;
                console.log("Loading post:", slug);
                loadPostForEdit(slug!);
                resultsContainer.classList.add("hidden");
              });
            });
          } else {
            resultsContainer.innerHTML =
              '<div class="p-3 text-sm text-gray-500 text-center">No signals found.</div>';
            resultsContainer.classList.remove("hidden");
          }
        } catch (err) {
          console.error(err);
        }
      }, 300);
    });

    // Hide on click outside
    document.addEventListener("click", (e) => {
      if (
        !searchInput.contains(e.target as Node) &&
        !resultsContainer.contains(e.target as Node)
      ) {
        resultsContainer.classList.add("hidden");
      }
    });

    // Load All Archives Logic
    const loadAllBtn = document.getElementById("load-all-signals-btn");
    const tableBody = document.getElementById("signal-log-body");

    loadAllBtn?.addEventListener("click", async () => {
      loadAllBtn.innerText = "Loading Archive...";
      loadAllBtn.setAttribute("disabled", "true");

      try {
        const res = await fetch("/api/posts?limit=all");
        const allPosts = (await res.json()) as any[];

        if (tableBody) {
          tableBody.innerHTML = allPosts
            .map((post) => {
              const isPublished = Date.now() >= (post.publishedAt || 0);
              const dateStr = new Date(
                post.publishedAt || post.createdAt,
              ).toLocaleDateString();

              return `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                      <td class="py-4">
                        <span class="inline-block w-2 h-2 rounded-full ${isPublished ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]" : "bg-yellow-400"}"></span>
                      </td>
                      <td class="py-4 font-medium text-white">${post.title}</td>
                      <td class="py-4 text-gray-400 font-mono text-xs">${dateStr}</td>
                      <td class="py-4 text-right flex items-center justify-end gap-2">
                        <button class="edit-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-brand-primary/20 text-gray-300 hover:text-brand-accent border border-white/10 hover:border-brand-primary/50 transition-all text-xs" data-slug="${post.slug}" title="Edit Post">
                          <span class="i-heroicons-pencil-square w-4 h-4"></span>
                        </button>
                        <button class="toggle-status-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-gray-300 hover:text-yellow-400 border border-white/10 hover:border-yellow-500/50 transition-all text-xs" data-slug="${post.slug}" data-status="${isPublished ? "published" : "draft"}" title="${isPublished ? "Unpublish (Hide)" : "Publish (Show)"}">
                          <span class="${isPublished ? "i-heroicons-eye-slash w-4 h-4" : "i-heroicons-eye w-4 h-4"}"></span>
                        </button>
                        <button class="delete-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/10 hover:border-red-500/50 transition-all text-xs" data-slug="${post.slug}" title="Delete Post">
                          <span class="i-heroicons-trash w-4 h-4"></span>
                        </button>
                      </td>
                    </tr>
                    `;
            })
            .join("");

          // Re-bind buttons since DOM changed
          bindActionButtons();

          loadAllBtn.classList.add("hidden");
          const countEl = document.getElementById("signal-log-count");
          if (countEl)
            countEl.innerText = `Showing All ${allPosts.length} Signals`;
        }
      } catch (e) {
        console.error(e);
        loadAllBtn.innerText = "Sync Failed";
      }
    });
  }
</script>
