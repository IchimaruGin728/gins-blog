---
import Layout from "../../layouts/Layout.astro";
import { getDb } from "../../lib/db";
import { posts } from "../../../db/schema";
import { eq, and, lte } from "drizzle-orm";
import Comments from "../../components/Comments";
import { marked } from "marked";
import ShareButtons from "../../components/ShareButtons.astro";

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/404");
}

const { env } = Astro.locals.runtime;
// CACHE LIFT: Check KV Layer first (Speed optimization)
const CACHE_KEY = `post:${slug}`;
let result = null;
let isCached = false;

try {
  const cached = await env.GINS_CACHE.get(CACHE_KEY, "json");
  if (cached) {
    result = cached as typeof posts.$inferSelect;
    isCached = true;
  }
} catch (e) {
  console.warn("KV Cache Miss/Error:", e);
}

// Fallback to D1 if not in Cache
if (!result) {
  const db = getDb(env);
  result = await db
    .select()
    .from(posts)
    .where(and(eq(posts.slug, slug), lte(posts.publishedAt, Date.now())))
    .get();

  // Hydrate Cache if found (Background non-blocking)
  if (result) {
    try {
      await env.GINS_CACHE.put(CACHE_KEY, JSON.stringify(result), {
        expirationTtl: 60 * 60 * 24 * 7, // 7 Days Cache
      });
    } catch (e) {
      console.warn("Failed to write to KV:", e);
    }
  }
}

if (!result) {
  return Astro.redirect("/404");
}
// Extract description from content (first 160 chars)
const contentPreview =
  result.content
    .replace(/<[^>]*>/g, "")
    .slice(0, 160)
    .trim() + "...";
const publishedTime = new Date(
  result.publishedAt || result.createdAt,
).toISOString();

// JSON-LD Structured Data
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: result.title,
  description: contentPreview,
  author: {
    "@type": "Person",
    name: "IchimaruGin728",
    url: "https://blog.ichimarugin728.com/about",
  },
  datePublished: publishedTime,
  dateModified: new Date(result.updatedAt).toISOString(),
  publisher: {
    "@type": "Organization",
    name: "Gin's Blog",
    logo: {
      "@type": "ImageObject",
      url: "https://blog.ichimarugin728.com/favicon.png",
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://blog.ichimarugin728.com/blog/${slug}`,
  },
};
---

<Layout
  title={result.title}
  description={contentPreview}
  type="article"
  publishedTime={publishedTime}
>
  <article class="max-w-3xl mx-auto">
    <header class="mb-12 text-center">
      <div
        class="inline-block px-4 py-1 rounded-full bg-brand-primary/10 text-brand-accent font-mono text-sm mb-6 border border-brand-primary/20"
      >
        {new Date(result.publishedAt || result.createdAt).toLocaleDateString()}
      </div>
      <h1 class="text-5xl font-display font-bold mb-6 leading-tight">
        {result.title}
      </h1>
    </header>

    <div
      class="glass-panel rounded-3xl p-8 md:p-12 prose prose-invert prose-lg max-w-none text-gray-300"
    >
      <!-- Assuming content is just text for now, in Future: Markdown/MDX -->
      <div
        class="whitespace-pre-wrap"
        set:html={marked.parse(result.content)}
      />
    </div>

    <Comments
      client:visible
      postId={result.id}
      currentUser={Astro.locals.user || undefined}
    />

    <div class="mt-12 text-center">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-brand-accent hover:text-white transition-colors"
      >
        <span class="i-heroicons-arrow-left"></span>
        Back to Overview
      </a>
    </div>
  </article>

  <!-- JSON-LD Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />

  <!-- Share Buttons -->
  <div class="max-w-3xl mx-auto mt-8">
    <ShareButtons
      url={Astro.url.href}
      title={result.title}
      description={result.content.substring(0, 160)}
    />
  </div>

  <!-- Comments Section -->
  <div class="max-w-3xl mx-auto mt-16">
    <Comments
      client:visible
      postId={result.id}
      currentUser={Astro.locals.user || undefined}
    />
  </div>
</Layout>
